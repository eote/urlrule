#!/usr/bin/perl -w
###APPNAME:     urlrule_action
###APPAUTHOR:   duel
###APPDATE:	Mon Mar 24 06:25:31 2008
###APPVER:	0.1
###APPDESC:     apply rule for URL,and perform action	
###APPUSAGE:	urlrule_action URL [0-5] [action args...]
###APPEXAMPLE:	urlrule_action http://www.sina.com.cn 0 cat
use strict;
use utf8;

use MyPlace::Script::Usage qw/help_required help_even_empty/;
exit 0 if(help_required($0,@ARGV));

use MyPlace::Script::Message;
use MyPlace::URLRule::OO;
#Processor;
use MyPlace::ReEnterable;
use Cwd qw/getcwd/;

#urlrule_set_callback('process_passdown',\&process_passdown);

my $RESUME_FILE = '.urlrule_resume';
my $phnd = MyPlace::ReEnterable->new('main');
my $cwd = getcwd();
$SIG{INT} = \&sig_killed;

my $RULE = new MyPlace::URLRule::OO(
		buildurl=>1,
		createdir=>1,
		callback_nextlevel=>\&process_passdown,
);

sub process_passdown {
	my ($resp) = @_;
    my $cwd = getcwd();
	$phnd->push($cwd,'load_rule',@{$resp}{qw/title url level action/});
}

sub load_rule {
    my $cwd = getcwd();
	my ($title,$url,$level,$action) = @_;
	$RULE->autoApply($url,$level,$action,$title);
    chdir $cwd;
}

sub sig_killed {
    app_message("saving remained tasks...\n");
    if($phnd->{lastStack}) {
        $phnd->unshift(@{$phnd->{lastStack}});
    }
    chdir($cwd) if($cwd);
    $phnd->saveToFile($RESUME_FILE);
    app_message($phnd->length," tasks saved to $RESUME_FILE\n");
    exit 1;
}

if(@ARGV) {
    $phnd->push($cwd,'load_rule',undef,@ARGV);
}
else {
    $phnd->loadFromFile($RESUME_FILE);
}
while(my $tasks = $phnd->length) {
    app_error("[$tasks] tasks remained\n");
    my @this = $phnd->peek();
    if(@this) {
        my $wdir = shift @this;
        my $cmd = shift @this;
#        app_warning("rule       -  @this\n");
#        app_warning("directory  -  $wdir\n");
    }
    $phnd->run();
}
app_message "All tasks completed.\n";
unlink $RESUME_FILE if(-f $RESUME_FILE);
exit 0;
